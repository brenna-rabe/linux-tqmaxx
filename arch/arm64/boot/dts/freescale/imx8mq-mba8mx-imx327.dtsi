// SPDX-License-Identifier: (GPL-2.0-or-later OR MIT)
/*
 * Copyright 2021-2023 TQ-Systems GmbH <linux@ew.tq-group.com>,
 * D-82229 Seefeld, Germany.
 * Author: Alexander Stein
 */

/ {
	sensor_clk: sensor-clk {
		#clock-cells = <0>;
		compatible = "fixed-clock";
		clock-frequency = <37125000>;
	};
};

&csi1_bridge {
	fsl,mipi-mode;
	dma-coherent;
	status = "okay";

	port {
		csi1_ep: endpoint {
			remote-endpoint = <&csi1_mipi_ep>;
		};
	};
};

&csi2_bridge {
	fsl,mipi-mode;
	dma-coherent;

	port {
		csi2_ep: endpoint {
			remote-endpoint = <&csi2_mipi_ep>;
		};
	};
};

&mipi_csi_1 {
	#address-cells = <1>;
	#size-cells = <0>;

	port {
		mipi1_sensor_ep: endpoint@0 {
			data-lanes = <1 2>;
			remote-endpoint = <&sony_imx327_ep0>;
		};

		csi1_mipi_ep: endpoint@1 {
			remote-endpoint = <&csi1_ep>;
		};
	};
};

&mipi_csi_2 {
	#address-cells = <1>;
	#size-cells = <0>;

	port {
		mipi2_sensor_ep: endpoint@0 {
		};

		csi2_mipi_ep: endpoint@1 {
			remote-endpoint = <&csi2_ep>;
		};
	};
};

&i2c3 {
	vc_fpga: fpga@10 {
		reg = <0x10>;
		compatible = "vc,fpga";

		vc_fpga_reg: regulator {
			regulator-name = "CAM_VCC";
		};

		vc_fpga_reset: reset {
			#reset-cells = <0>;
		};

		vc_fpga_gpio: gpio-chip {
			gpio-controller;
			#gpio-cells = <2>;
		};
	};

	sony_imx327: camera@1a {
		#address-cells = <0x1>;
		#size-cells = <0x0>;
		reg = <0x1a>;

		compatible = "sony,imx327", "sony,imx290";

		clock-names = "xclk";
		clocks = <&sensor_clk>;
		clock-frequency = <37125000>;

		vdd-supply = <&vc_fpga_reg>;

		vdda-supply = <&vc_fpga_reg>;
		vddd-supply = <&vc_fpga_reg>;
		vdddo-supply = <&vc_fpga_reg>;

		reset-gpios = <&vc_fpga_gpio 0 GPIO_ACTIVE_HIGH>;

		port@0 {
			reg = <0>;

			sony_imx327_ep0: endpoint {
				remote-endpoint = <&mipi1_sensor_ep>;
				data-lanes = <1 2>;
				clock-lanes = <0>;
				clock-noncontinuous = <1>;
				link-frequencies = /bits/ 64 <445500000 297000000>;
			};
		};
	};
};

&mipi_csi_1 {
	status = "okay";

	/* https://community.nxp.com/t5/i-MX-Processors/Fixing-base-address-switching-Change-Err-which-occurs-randomly/m-p/902311 */
	assigned-clock-rates = <
		200000000			/* > mipi bandwidth/8 */
		333000000			/* > pixclk */
		66000000
	>;
};
